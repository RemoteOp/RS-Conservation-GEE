
// charting period 
var startYear = 2000;
var endYear = 2020;
var startMonth = 1;
var endMonth = 12;

// baseline period 
var b_start = "2000-01-01";
var b_end = "2015-02-28";

// start and end day numbers of the year for calculating the baseline
var bm_start = 1;
var bm_end = 365;

// anomaly (study) period
var anom_start = "2015-03-01";
var anom_end = "2018-07-31";

// date range for filtering Landsat collection
var f_start = '2000-01-01';
var f_end = '2020-12-31';


// LOAD LANDSAT AND DEFINE FUNCTIONS//

// Landsat 7 surface reflectance (SR) collection
var dataset = ee.ImageCollection("LANDSAT/LE07/C02/T1_L2")
                  .filterDate(f_start, f_end)
                  .filterBounds(HR_AOI);

print(dataset.first(),"dataset");

// Masking Landsat 7 surface reflectance images
function prepSrL8(image) {
  var qaMask = image.select('QA_PIXEL').bitwiseAnd(parseInt('11111', 2)).eq(0);
  var saturationMask = image.select('QA_RADSAT').eq(0);

  // Applying the scaling factors to bands.
  var getFactorImg = function(factorNames) {
    var factorList = image.toDictionary().select(factorNames).values();
    return ee.Image.constant(factorList);
  };
  var scaleImg = getFactorImg([
    'REFLECTANCE_MULT_BAND_.|TEMPERATURE_MULT_BAND_ST_B6']);
  var offsetImg = getFactorImg([
    'REFLECTANCE_ADD_BAND_.|TEMPERATURE_ADD_BAND_ST_B6']);
  var scaled = image.select('SR_B.|ST_B6').multiply(scaleImg).add(offsetImg);

  // Replacing original bands with scaled bands and applying masks.
  return image.addBands(scaled, null, true)
    .updateMask(qaMask).updateMask(saturationMask);
}

// Calculating NDVI in vegetated areas
var lc = ee.ImageCollection('ESA/WorldCover/v200').first().clip(HR_AOI);

var addNDVI = function(image) {
  var ndvi = image.normalizedDifference(['SR_B4', 'SR_B3']).rename('NDVI')
                 .updateMask(lc.eq(10).or(lc.eq(20)).or(lc.eq(30)));
  return image.addBands(ndvi);
};

// Applying functions on filtered image collection
var cloudmasked = dataset.map(prepSrL8); 
var withNDVI = cloudmasked.map(addNDVI);

// Creating new filtered collection covering only baseline period
var withNDVI_baseline = withNDVI.filterDate(b_start, b_end); 


// CALCULATE MONTHLY NDVI AND ANOMALIES //

var years = ee.List.sequence(startYear, endYear);
var months = ee.List.sequence(startMonth, endMonth);

// Calculate monthly average NDVI over full period
var monthlyNDVI =  ee.ImageCollection.fromImages(
  years.map(function(y) {
    return months.map(function(m) {
      var filtered = withNDVI
                          .select("NDVI")
                          .filter(ee.Filter.calendarRange(y, y, 'year'))
                          .filter(ee.Filter.calendarRange(m, m, 'month'))
                          .mean();
      return filtered.set({
        'year': y,
        'month': m,
        'system:time_start': ee.Date.fromYMD(y, m, 1).millis()
      });
    });
  }).flatten()
);
print(monthlyNDVI,"Monthly NDVI");

// Debug – checking if any months are totally empty
var emptyMonths = monthlyNDVI
  .filter(ee.Filter.eq('bandNames', []))
  .aggregate_array('system:time_start')
  .map(function(ms) {
    return ee.Date(ms).format('YYYY-MM');
  });
print('Months with empty NDVI:', emptyMonths);

// Calculating monthly average NDVI across baseline period
var meanMonthlyNDVI = ee.ImageCollection.fromImages(
  ee.List.sequence(1, 12).map(function(m) {
    var filtered = monthlyNDVI
      .filterDate(b_start, b_end)
      .filter(ee.Filter.eq('month', m)).mean();
    return filtered.set('month', m);
  })
);

// Function to compute the anomaly for a given month
var computeAnomaly = function(image) {
  var year = image.get('year');
  var month = image.get('month');

  var referenceImage = meanMonthlyNDVI
      .filter(ee.Filter.eq('month', month))
      .first();

  var hasBands = image.bandNames().size().gt(0);

  var anomalyImage = ee.Algorithms.If(
    hasBands,
    ee.Algorithms.If(
      referenceImage.bandNames().size().gt(0),
      image.subtract(referenceImage),
      image
    ),
    image
  );
  
  return ee.Image(anomalyImage).set({
      'system:time_start': image.get('system:time_start'),
      'year': year,
      'month': month
  });
};

// Mapping the function over the monthly NDVI collection to compute
// the anomaly NDVI for each month (whole charting period)
var monthlyNDVIAnomalies = monthlyNDVI.map(computeAnomaly);
print("monthly NDVI anomalies (all years)", monthlyNDVIAnomalies);

// Restricting anomalies to anomaly period only 
var monthlyNDVIAnomalies_anom = monthlyNDVIAnomalies
    .filterDate(anom_start, anom_end);

print("monthly NDVI anomalies (anomaly period only)", monthlyNDVIAnomalies_anom);


// DEVELOPING NDVI ANOMALY GRAPH (for anomaly period only)//

var chart =
  ui.Chart.image.series({
      imageCollection: monthlyNDVIAnomalies_anom,
      region: HR_AOI,
      scale: 100,
      xProperty: 'system:time_start'
    })
    .setSeriesNames(['NDVI anomaly'])
    .setOptions({
      title: 'Monthly NDVI anomaly (study period)',
      series: {
        0: {
            targetAxisIndex: 0, type: 'line', lineWidth: 3,
            pointSize: 1, color: '#ffc61a'
        }
      },
      hAxis: {
        title: 'Date',
        titleTextStyle: {italic: false, bold: true}
      },
      vAxes: {
        0: {
            title: 'NDVI anomaly',
            baseline: 0, titleTextStyle: {bold: true, color: '#1a1aff'}
        }
      },
      curveType: 'function'
    });

print(chart);


// CONVERTING DATA TO TABLE (anomaly period only) 

var meanByMonth = monthlyNDVIAnomalies_anom.map(function(image) {
  var meanDict = image.reduceRegion({
    geometry: HR_AOI,
    reducer: ee.Reducer.mean(),
    scale: 100
  });
  return ee.Feature(null, meanDict)
           .set('year', image.get('year'))
           .set('month', image.get('month'));
});

print("meanByMonth", meanByMonth);


// CALCULATING NDVI ANOMALY IMAGE//

// Long-term mean baseline NDVI over full year 
var baseline = withNDVI_baseline
  .select("NDVI")
  .filter(ee.Filter.dayOfYear(bm_start, bm_end))
  .mean();
  
// MEAN ANOMALY MAP
// -------------------------

// Mean NDVI during study period
var study_meanNDVI = withNDVI
  .filterDate(anom_start, anom_end)
  .select("NDVI")
  .mean()
  .clip(HR_AOI);

// Mean anomaly = (study mean) − (baseline mean)
var meanAnomaly = study_meanNDVI.subtract(baseline).rename("NDVI_mean_anomaly");

// Greenest pixel / Peak NDVI over anomaly period in the HR
//var HR_mean = withNDVI
//    .filterDate(anom_start, anom_end)
 //   .qualityMosaic("NDVI")
 //   .clip(HR_AOI);

// Composite anomaly map
var anomaly_HR = study_meanNDVI.select("NDVI").subtract(baseline);
var anom_vis = {min: -0.1, max: 0.1, palette: ['FF0000', '000000', '00FF00']};

// VisualisING image
Map.addLayer(anomaly_HR, anom_vis, "Mean NDVI anomaly HR");
Map.centerObject(HR_AOI);


// EXPORTS 

// Export table of monthly anomalies
Export.table.toDrive({
  collection: meanByMonth,
  description: "Sanitaka_mean_monthly_ndvia",
  fileFormat: 'CSV',
  selectors: ["year","month","NDVI"] 
});

// Export geotiff for HR anomaly composite
Export.image.toDrive({
  image: anomaly_HR,
  description: 'NDVI_anomaly_2015_2018',
  maxPixels:  3230585632,
  region: HR_AOI,
  scale: 100
});
